# KeyerProject
## Решение задачи кеинга изображений с использованием формулы Влахоса
### Системные требования
<ul>
  <li>ОС: Windows 7+ 64-bit</li>
  <li>.NET 6 или выше</li>
</ul>

---

### Описание
Программа позволяет пользователю загрузить изображение в формате PNG (RGB) размером 1920x1080, вырезать цвет кеинга и сохранить итоговое изображение в формате PNG (RGBA).

<details>
  <summary>Инструкция по работе с программой</summary>

---
  
### Инструкция по работе с программой
1. Нажать на кнопку "Загрузить"
  ![Step1](https://github.com/PyromaniacSquid/KeyerProject/assets/68219629/657d0a6a-0ae1-4a4d-8179-2d9b67eb26a1)
2. Выбрать исходное изображение в открывшемся диалоговом окне
![Step2](https://github.com/PyromaniacSquid/KeyerProject/assets/68219629/fd4b280a-4216-4572-a4e4-6fcc0d02890b)
3. Выбрать цвет кеинга, нажав левой кнопкой мыши по пикселю соответствующего цвета на изображении
![Step3](https://github.com/PyromaniacSquid/KeyerProject/assets/68219629/9fc1e3d5-b7a5-47a5-824d-06b3134978ce)
4. Задать параметры кеинга:
  1. С помощью ползунка задать значение коэффициента влияния зеленого компонента RGB *(или нажать на чекбокс "Автовыбор" - рекомендуется)*
  2. С помощью ползунка задать значение коэффициента влияния синего компонента RGB
  3. С помощью ползунка задать значение коэффициента влияния красного компонента
  4. С помощью ползунка задать пороговое значение отбора переднего плана *(подробно описано в методе)*
  Рекомендуется задать начальное значение 90% и изменять его в случае необходимости
  6. С помощью ползунка задать знчаение дополнительного процента непрозрачности границ *(подробно описано в методе)*

  Точная настройка зависит от цвета фона исходного изображения, и требует экспериментальной конфигурации
  
![Step4](https://github.com/PyromaniacSquid/KeyerProject/assets/68219629/941d8699-0639-42f9-8e9c-f80bb0df41b9)

5. Нажать на кнопку "Обработка" для запуска кеинга
![Step5](https://github.com/PyromaniacSquid/KeyerProject/assets/68219629/05b49268-bedd-4d10-be2b-e8d4e4f3651c)
7. При необходимости, повторить шаги 4-5 для достижения наилучшего эффекта кеинга
8. Сохранить полученное изображение, нажав на кнопку "Сохранить" *(в текущей версии конфигурация сохранения файла недоступна)*

</details>

---

### Примеры
<details>
  <summary>Тест 1. Женщина на однотонном зеленом фоне</summary>
  
  **Входное изображение**
  
  ![img_green_in](https://github.com/PyromaniacSquid/KeyerProject/assets/68219629/f3dac734-f46c-4e7c-b883-8af3efdc7f2b)

  **Результат**
  ![woman](https://github.com/PyromaniacSquid/KeyerProject/assets/68219629/217d3549-7040-437f-afec-64c0924bc758)

</details>

<details>
  <summary>Тест 2. Мужчина на зеленом фоне с разной освещенностью</summary>

  **Входное изображение**

  ![kayvon](https://github.com/PyromaniacSquid/KeyerProject/assets/68219629/657d032d-b122-42cb-8f91-7f074f61a87b)

  **Результат**

  ![dudethebest](https://github.com/PyromaniacSquid/KeyerProject/assets/68219629/6f4c2c57-f5c3-4984-b3cb-e40edacd170b)

</details>

<details>
  <summary>Тест 3. Слон на зеленом фоне с разной освещенностью</summary>

  **Входное изображение**

  ![elephant](https://github.com/PyromaniacSquid/KeyerProject/assets/68219629/e9813e0f-30dd-4f01-975e-be1209d757c7)

  **Результат**
  
  ![elephant](https://github.com/PyromaniacSquid/KeyerProject/assets/68219629/d7adb48c-ed9c-4266-8dcc-37843cff10e3)

</details>
---

### Метод


**Загрузка изображения**

Загруженное пользователем изображение преобразуется в Bitmap для отрисовки в главном окне программы.
Полученный BitmapImage преобразуется в двумерный массив кастомных элементов PixelColor, хранящих RGBA-значение пикселей.

---

**Выбор цвета кеинга**

Цвет пикселя изображения, по которому пользователь нажал левой клавишей мыши, запоминается в переменной selectedKeyColor

---

**Кеинг**

Для кеинга используется формула Влахоса, позволяющая аппроксимировать RGBA значение цвета объекта переднего плана на каждом пикселе изображения.
Коэфициенты $k_1, k_2, k_3$ используются для определения показателя $\alpha$ - непрозрачности переднего плана
$$\alpha = 1 - k_1 * (\min(G_k, G) - k_2 * (k_3 * B + (1 - k_3) * R)$$
где $G_k$ - зеленый компонент цвета кеинга, $R, G, B$ - RGB-значения обрабатываемого пикселя
Коэфициент $k_1$ может высчитываться программой автоматически по формуле
$$k_1 = 1/(G_k-k_2*B_k)$$
где $G_k, B_k$ - зеленый и синий компоненты цвета кеинга

Полученное значение непрозрачности используется для определения категории пикселя:
1. Фон ($\alpha < 0.1$) - альфа-каналу присваивается значение 0 (непосредственный кеинг)
2. Граница ($0.1 < \alpha < p$) - альфа-каналу присваивается значение $alpha$ с усилением, равным значению доп. непрозрачности, установленным пользователем
   Значение p устанавливается пользователем с помощью ползунка "Чувствительность"
3. Объект переднего плана ($alpha \geq p$) - альфа каналу присваивается значение 255 (соответствуя постановке задачи, исходное изображение не имеет альфа-канала, вследствие все пиксели имели значение A=255)
Подробная информация о методе представлена в источниках, ссылки прикреплены в конце данной страницы.

---

### Возможные модификации и улучшения
1. Размытие граничных пикселей
2. Функционал объединения полученного изображения с новым фоном *(не входило в ТЗ, но задача интересная)*
3. Окно предварительного просмотра изменений
4. Автовыбор цвета кеинга

---

### Заметки разработчика
Интересный проект, потребовавший взяться за старое и новое одновременно
В первую очередь были отброшены идеи использования существующих библиотек (OpenCV и аналогов), для поддержания исследовательской и творческой души проекта.
Имея опыт работы с Bitmap в C++ (WinAPI), было непривычно пересаживаться на классы в C# WPF, однако проект заинтересовал на дальнейшее изучение аспектов .NET
Для изучения и реализации метода пришлось обратиться к Стенфордским лекциям и лабораторным работам
Тем не менее, реализация предложенного метода не справлялась с поставленной задачей - пришлось вводить дополнительные параметры для улучшения качества итоговой обработки
Когда полученный алгоритм смог справиться с кеингом неоднотонных изображений (тестовая выборка из задач в Стенфорде), было принято решение перейти к рефакторингу и написанию документации

На момент написания данного раздела, проект не имеет очевидно необходимой многопоточности обработки пикселей, однако ситуация может измениться.

---

**Оценки**

**Постановка задачи - 8/10 😄**

Несложно, но интересно

**Негативные эмоции в процессе разработки - 7/10 😤**

3/4 времени работы над проектом что-либо да не работало, но время пролтело незаметно

**Удовольствие от результата - 9/10 🥳**

---

### Источники
[Лабораторная Стенфорда](https://graphics.stanford.edu/wikis/cs148-07/Assignment6?action=show)

[Какой-то сайт](https://araintelligence.com/blogs/computer-vision/image-processing/image_matting_1)
